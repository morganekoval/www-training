<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>wwww-training</title>
  <!-- Loads all styles -->
  <link rel="stylesheet" href="style/main.css">
  <link rel="icon" href="resources/icon.png">

  <!-- Loads all libraries -->
  <script src="lib/jquery-3.3.1.min.js"></script>
  <script src="resources/country-data.js"></script>
</head>
<body>

  <div id="quizz">
    <h1>www-training</h1>
    <div id="progress" hidden><!-- <div id="inside-progress"></div><div id="inside-progress2"></div> --></div>
    <div id="flag-holder">
      <input id="numberquiz" type="number" value="10">
      <button onclick="startQuiz()">Commencer</button>
    </div>
    <form id="inputs" hidden>
      <span id="answer-holder">
        <input type="text" id="answer" name="answer" minlength="0" maxlength="35" class="regularanswer">
     </span>
       <input id="submit" type="submit" value="Valider">
    </form>
  </div>


</body>
</html>

<script type="text/javascript">

function randomOrder() {
  var num_tab = [];
  for (var i = 0; i < country_data.length; i++) {
    num_tab.push(i);
  }
  for (var i = num_tab.length-1 ; i > 0 ; i--) {
    const rdm = Math.floor(Math.random() * (i + 1));
    const tmp = num_tab[i];
    num_tab[i] = num_tab[rdm];
    num_tab[rdm] = tmp;
  }
  return num_tab;
}

function setProgress(correct) {
  if (correct) {
    document.getElementById("progress").innerHTML = document.getElementById("progress").innerHTML+ "<div style=\"display: inline-block;background-color: green;width: "+50/quiz_length+"vw;height: 4vh;\"></div>"
  } else {
    document.getElementById("progress").innerHTML = document.getElementById("progress").innerHTML+ "<div style=\"display: inline-block;background-color: red;width: "+50/quiz_length+"vw;height: 4vh;\"></div>"
  }
}

function changeFlag(num) {
  $("div#flag-holder").html("<img id=\"flag-img\" src=\""+country_data[num].imgurl+"\" alt=\""+country_data[num].filename+"\">");
}

var score = 0;
var quiz_length = 10;
var countries = [];
var incorrect_countries = [];
var elapsed_time = 0;

function startQuiz() {
  document.getElementById("progress").innerHTML = "";
  score = 0;
  incorrect_countries = [];
  console.log(country_data.length);
  document.getElementById("inputs").hidden = false;
  document.getElementById("submit").hidden = false;
  document.getElementById("progress").hidden = false;
  setAnswerField("","regularanswer");
  var input_number = $("#numberquiz").val();
  console.log(input_number);
  if (input_number == undefined || input_number == 0) {
    input_number = 1;
  } else if (input_number > country_data.length) {
    input_number = country_data.length;
  }
  quiz_length = input_number;
  console.log(quiz_length);
  countries = randomOrder().slice(0,quiz_length);
  changeFlag(countries[countries.length-1]);
  elapsed_time = Date.now();
}

// distance de Levenshtein ?
function levenshtein(a,b,res=0) {
  if (res > 2) {
    return res;
  }
  if (Math.min(a.length,b.length) == 0) {
    return Math.max(a.length,b.length);
  } else if (a.charAt(0) == b.charAt(0)) {
    return levenshtein(a.slice(1),b.slice(1),res);
  } else {
    return 1 + Math.min(levenshtein(a.slice(1),b,res+1),levenshtein(a,b.slice(1),res+1),levenshtein(a.slice(1),b.slice(1),res+1));
  }
}

function removeParentheses(str) {
  return str.replace("(","").replace(")","");
}

function removeBetweenParentheses(str) {
  return str.replace(/\(.+[^)]\)/,"");
}

function checkAnswer(answer,correction) {
  // return (levenshtein(answer.toLowerCase(),correction.toLowerCase()) <= 2);
  const res = levenshtein(answer.toLowerCase(),correction.toLowerCase());
  console.log(res);
  if (res > 2) {
    return false;
  }
  return true;
}

function setAnswerField(val,cls) {
  $("span#answer-holder").html("<input type=\"text\" id=\"answer\" name=\"answer\" minlength=\"0\" maxlength=\"35\" size=\"35\" value=\""+val+"\" class=\""+cls+"\">");
}

function elapsedTimeMinutes(tm) {
  tm = tm/1000;
  const min = Math.floor(tm/60);
  const sec = Math.round(tm%60);
  return min+" min "+sec+" s";
}

function showCorrection() {
  $("span#answer-holder").html("");
  incorrect_countries.forEach(function(country){
    var country_info = country_data[country];
    document.getElementById("answer-holder").innerHTML += "<div><img id=\"flag-img-corr\" src=\""+country_info.imgurl+"\" alt=\""+country_info.filename+"\"> <span class=\"incorrect\">"+country_info.capital+"</span></div>";
  });
}

function endGame() {
  $("#flag-holder").html("Score : "+score+"/"+quiz_length+" en "+elapsedTimeMinutes(Date.now()-elapsed_time)+"<br/><input id=\"numberquiz\" type=\"number\" value=\""+quiz_length+"\"><button onclick=\"startQuiz()\">Recommencer</button>");
  showCorrection();
  document.getElementById("submit").hidden = true;
  console.log(incorrect_countries);
}



function nextFlag() {
  document.getElementById("submit").disabled = true;
  var country = countries.pop();
  var correction = country_data[country].capital;
  var resp;
  if (correction.includes("(")) {
    const correction2 = removeBetweenParentheses(correction);
    console.log(correction2);
    correction = removeParentheses(correction)
    console.log(correction);
    resp = (checkAnswer($("#answer").val(),correction) || checkAnswer($("#answer").val(),correction2));
  } else {
    resp = checkAnswer($("#answer").val(),correction);
  }
  var cls;
  var sleeptime = 2500;
  if (resp) {
    score +=1;
    cls = "correct";
    sleeptime=500;
    setProgress(resp);
  } else {
    cls = "incorrect";
    setProgress(resp);
    incorrect_countries.push(country);
  }
  setAnswerField(correction,cls);
  setTimeout(function(){
    if (countries.length != 0) {
      changeFlag(countries[countries.length-1]);
      setAnswerField("","regularanswer");
      $("#answer").focus();
    } else {
      endGame();
    }
    document.getElementById("submit").disabled = false;
  },sleeptime);

}


inputs.addEventListener("submit", function (e) {
  e.preventDefault();
  nextFlag();
});

$(window).on('load', function () {
  // var r_country_num = getRandomCountryNumber();
  // changeFlag(r_country_num);
  // console.log(country_data[r_country_num].imgurl);
  

});




</script>